<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AURA | Quantitative Market Sentinel</title>

    <!-- Dynamic Favicon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='0%25'%3E%3Cstop offset='0%25' style='stop-color:%2360a5fa'/%3E%3Cstop offset='50%25' style='stop-color:%23c084fc'/%3E%3Cstop offset='100%25' style='stop-color:%23f472b6'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='32' cy='32' r='30' fill='%23000000' stroke='url(%23g)' stroke-width='2'/%3E%3Cpath d='M32 14L50 50H14L32 14Z' fill='none' stroke='url(%23g)' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E" type="image/svg+xml">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=SF+Pro+Display:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Apple-esque Dark Mode Palette */
            --bg-deep: #000000;
            
            /* Glassmorphism Variables */
            --glass-surface: rgba(20, 20, 23, 0.65);
            --glass-border: rgba(255, 255, 255, 0.12);
            --glass-highlight: rgba(255, 255, 255, 0.05);
            --glass-blur: blur(40px);
            
            /* Text Colors */
            --text-primary: #f5f5f7;
            --text-secondary: #86868b;
            --text-tertiary: #6e6e73;

            /* Iridescent Gradients (The "Rainbow" Effect) */
            --gradient-iridescent: linear-gradient(135deg, #60a5fa 0%, #c084fc 50%, #f472b6 100%);
            
            /* Semantic Colors */
            --success: #32d74b;
            --danger: #ff453a;
            --neutral: #ff9f0a;

            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background-color: var(--bg-deep);
            color: var(--text-primary);
            font-family: var(--font-main);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden; /* Prevent horizontal scroll from effects */
            -webkit-font-smoothing: antialiased;
        }

        /* --- Ambient Background Orbs --- */
        .ambient-light {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            animation: floatOrb 20s infinite ease-in-out;
        }

        /* Responsive Orb Sizes */
        .orb-1 { width: min(600px, 60vw); height: min(600px, 60vw); background: #2563eb; top: -10%; left: -10%; animation-delay: 0s; }
        .orb-2 { width: min(500px, 50vw); height: min(500px, 50vw); background: #9333ea; bottom: -10%; right: -10%; animation-delay: -5s; }
        .orb-3 { width: min(400px, 40vw); height: min(400px, 40vw); background: #db2777; top: 40%; left: 40%; animation-delay: -10s; opacity: 0.2; }

        @keyframes floatOrb {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
        }

        /* --- Ticker --- */
        .tv-ticker-wrapper {
            width: 100%;
            height: 48px;
            position: sticky;
            top: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
        }

        .container {
            width: 100%;
            max-width: 860px;
            padding: 5rem 2rem 3rem 2rem;
            box-sizing: border-box;
            position: relative;
            z-index: 1;
        }

        /* --- Typography --- */
        header {
            text-align: center;
            margin-bottom: 4rem;
        }

        /* RAINBOW FROSTED TEXT STYLE */
        h1.brand-title {
            font-size: 3.5rem;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.02em;
            
            /* Rainbow Gradient Background */
            background: linear-gradient(
                135deg, 
                #60a5fa 0%, 
                #c084fc 25%, 
                #f472b6 50%, 
                #c084fc 75%, 
                #60a5fa 100%
            );
            background-size: 200% auto;
            
            /* Clip to text */
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            
            /* Frosted/Glowing Effect */
            filter: drop-shadow(0 0 15px rgba(192, 132, 252, 0.3));
            
            /* Subtle Shine Animation */
            animation: textShine 4s linear infinite;
        }

        @keyframes textShine {
            to { background-position: 200% center; }
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-top: 0.8rem;
            font-weight: 400;
            letter-spacing: 0.02em;
        }

        /* --- Apple-style Frosted Glass Card --- */
        .glass-card {
            background: var(--glass-surface);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 3rem;
            box-shadow: 
                0 40px 80px -20px rgba(0, 0, 0, 0.5),
                inset 0 0 0 1px var(--glass-highlight);
            margin-bottom: 2.5rem;
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), box-shadow 0.4s ease;
            position: relative;
            overflow: hidden;
            word-wrap: break-word; /* Prevents layout breaks */
        }
        
        /* Subtle shine effect on top of card */
        .glass-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        }

        /* --- Inputs --- */
        .input-group { margin-bottom: 2rem; }

        label.premium-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .clear-key-link {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            text-decoration: none;
            cursor: pointer;
            transition: color 0.2s;
        }
        .clear-key-link:hover { color: var(--danger); }

        input[type="password"] {
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            padding: 18px 20px;
            border-radius: 14px;
            font-family: var(--font-main);
            font-size: 16px; /* Prevents iOS zoom */
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: #60a5fa;
            background: rgba(0, 0, 0, 0.4);
            box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.15);
        }

        /* Custom Placeholder Color */
        ::placeholder {
            color: rgba(255, 255, 255, 0.3);
            font-weight: 300;
        }

        .info-text {
            font-size: 0.95rem;
            color: var(--text-secondary);
            line-height: 1.6;
            background: rgba(255, 255, 255, 0.03);
            padding: 1.5rem;
            border-radius: 16px;
            margin-bottom: 2rem;
        }

        /* --- Iridescent Button --- */
        .btn-iridescent {
            background: var(--gradient-iridescent);
            background-size: 200% 200%;
            animation: gradientMove 5s ease infinite;
            color: #ffffff;
            border: none;
            padding: 18px 32px;
            border-radius: 99px; /* Pill shape */
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            box-shadow: 0 10px 30px -10px rgba(192, 132, 252, 0.5);
            position: relative;
            overflow: hidden;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .btn-iridescent:hover {
            transform: scale(1.02);
            box-shadow: 0 15px 40px -10px rgba(192, 132, 252, 0.7);
        }

        .btn-iridescent:active { transform: scale(0.98); }

        .btn-iridescent:disabled {
            background: #2c2c2e;
            color: #636366;
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
            animation: none;
        }

        /* --- Loading State --- */
        .loading-container {
            text-align: center;
            display: none;
            padding: 4rem 0;
        }

        .iridescent-spinner {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient-iridescent);
            mask: radial-gradient(transparent 55%, black 56%);
            -webkit-mask: radial-gradient(transparent 55%, black 56%);
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem auto;
        }

        #loading-text { 
            background: var(--gradient-iridescent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 600; 
            font-size: 1.2rem; 
            margin-bottom: 0.5rem; 
        }
        #loading-subtext { color: var(--text-secondary); }
        #retry-status { color: var(--text-tertiary); font-style: italic; margin-top: 1rem; min-height: 1.2em; font-size: 0.9rem; }

        /* --- Results Section --- */
        #result-section {
            display: none;
            animation: slideUpFade 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* --- Dashboard Grids --- */
        .section-title {
             font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 1rem; display: block; font-weight: 600;
        }

        .rates-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .internals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin-bottom: 2.5rem;
        }

        .rate-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 18px;
            padding: 1.5rem;
            text-align: center;
            transition: background 0.2s;
        }
        .rate-card:hover { background: rgba(255,255,255,0.05); }

        .rate-title {
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .rate-value {
            font-size: 2rem;
            color: var(--text-primary);
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        
        .rate-value.small { font-size: 1.5rem; }

        /* --- Score & Verdict --- */
        .score-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2.5rem;
            padding-bottom: 2.5rem;
            border-bottom: 1px solid var(--glass-border);
            flex-wrap: wrap; /* Fix for mobile overlapping */
            gap: 2rem;
        }

        .score-circle-premium {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            /* Rainbow border logic */
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.5rem;
            font-weight: 700;
            color: #fff;
            background: #1c1c1e; /* Inner bg */
            z-index: 1;
            flex-shrink: 0; /* Prevent shrinking on mobile */
        }
        
        /* Gradient Border for Score Circle */
        .score-circle-premium::before {
            content: "";
            position: absolute;
            inset: -3px; /* Border width */
            border-radius: 50%;
            background: var(--gradient-iridescent);
            z-index: -1;
            opacity: 0.6;
        }

        .verdict-box { 
            text-align: right; 
            flex-grow: 1;
        }
        
        .verdict-label { display: block; color: var(--text-secondary); font-size: 0.85rem; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 0.5rem;}

        .verdict-value-premium {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .used-model-badge {
            display: inline-block;
            font-size: 0.75rem;
            color: var(--text-tertiary);
            background: rgba(255, 255, 255, 0.05);
            padding: 6px 14px;
            border-radius: 20px;
            margin-top: 1rem;
        }

        /* --- Color Modifiers --- */
        .v-bullish { color: var(--success); text-shadow: 0 0 40px rgba(50, 215, 75, 0.4); }
        .v-bearish { color: var(--danger); text-shadow: 0 0 40px rgba(255, 69, 58, 0.4); }
        .v-neutral { color: var(--neutral); }

        /* --- Report Text --- */
        .report-content h3 {
            background: linear-gradient(90deg, #fff, #a1a1aa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            margin-top: 0;
            letter-spacing: -0.01em;
        }

        .report-text-premium {
            line-height: 1.8;
            color: var(--text-primary);
            white-space: pre-line;
            font-size: 1.05rem;
            font-weight: 300;
        }

        /* --- Breakdown Grid --- */
        .model-breakdown-container {
            margin-top: 3rem;
            border-top: 1px solid var(--glass-border);
            padding-top: 2rem;
        }
        
        .model-breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
        }

        .breakdown-pill {
            background: rgba(255, 255, 255, 0.03);
            padding: 14px 18px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .breakdown-pill:hover { 
            background: rgba(255,255,255,0.06); 
            border-color: rgba(255,255,255,0.1);
            transform: translateY(-2px);
        }

        .pill-weight {
            font-weight: 700;
            /* Gradient text for percentage */
            background: var(--gradient-iridescent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-right: 10px;
            font-size: 1.1rem;
        }

        /* --- Animations --- */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideUpFade { from { opacity: 0; transform: translateY(40px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }

        /* --- Mobile --- */
        @media (max-width: 600px) {
            h1.brand-title { font-size: 2.2rem; }
            .score-header { flex-direction: column; text-align: center; gap: 2rem;}
            .verdict-box { text-align: center; }
            .glass-card { padding: 1.5rem; }
            .rates-grid { grid-template-columns: 1fr; }
            .orb { opacity: 0.3; }
        }
    </style>
</head>
<body>

    <!-- Ambient Background -->
    <div class="ambient-light">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

    <!-- TradingView Ticker Tape -->
    <div class="tv-ticker-wrapper">
        <div class="tradingview-widget-container">
            <div class="tradingview-widget-container__widget"></div>
            <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
            {
            "symbols": [
                { "proName": "NASDAQ:NVDA", "title": "NVIDIA" },
                { "proName": "NASDAQ:MSFT", "title": "Microsoft" },
                { "proName": "NASDAQ:AAPL", "title": "Apple" },
                { "proName": "NASDAQ:GOOGL", "title": "Alphabet" },
                { "proName": "NASDAQ:AMZN", "title": "Amazon" },
                { "proName": "NASDAQ:META", "title": "Meta" },
                { "proName": "FOREXCOM:SPXUSD", "title": "S&P 500" },
                { "proName": "FOREXCOM:NSXUSD", "title": "US 100" },
                { "proName": "FX:EURUSD", "title": "EUR/USD" }
            ],
            "showSymbolLogo": true,
            "colorTheme": "dark",
            "isTransparent": true,
            "displayMode": "adaptive",
            "locale": "en"
            }
            </script>
        </div>
    </div>

<div class="container">
    <header>
        <h1 class="brand-title">AURA</h1>
        <div class="subtitle">Quantitative Market Intelligence</div>
    </header>

    <div class="glass-card">
        <div class="input-group">
            <label for="apiKey" class="premium-label">
                Gemini API Key
                <span class="clear-key-link" onclick="clearKey()" title="Remove key from local storage">Clear saved key</span>
            </label>
            <input type="password" id="apiKey" placeholder="input your key here">
        </div>

        <div class="info-text">
            <span style="color: #fff; font-weight: 500;">Research Protocol:</span>
            The system executes a live Google Search Grounding to extract Real Yields, CPI, VIX, Policy Rates, and Commodity prices. Data is processed locally in your browser.
        </div>

        <button class="btn-iridescent" onclick="startAnalysisChain()">Initialize Analysis</button>
    </div>

    <!-- Loading Screen -->
    <div id="loading" class="loading-container">
        <div class="iridescent-spinner"></div>
        <div id="loading-text">Synthesizing Data...</div>
        <div id="loading-subtext">Scanning Global Markets & Central Banks</div>
        <div id="retry-status"></div>
    </div>

    <!-- Results Dashboard -->
    <div id="result-section" class="glass-card">
        
        <!-- Live Rates Display -->
        <h4 class="section-title">Central Bank Policy</h4>
        <div class="rates-grid">
            <div class="rate-card">
                <div class="rate-title">Fed Funds (Upper)</div>
                <div class="rate-value" id="fed-rate-display">--%</div>
            </div>
            <div class="rate-card">
                <div class="rate-title">ECB (Main Refi)</div>
                <div class="rate-value" id="ecb-rate-display">--%</div>
            </div>
        </div>

        <!-- NEW: Market Internals -->
        <h4 class="section-title">Market Internals</h4>
        <div class="internals-grid">
            <div class="rate-card">
                <div class="rate-title">US 10Y Yield</div>
                <div class="rate-value small" id="us10y-display">--%</div>
            </div>
            <div class="rate-card">
                <div class="rate-title">VIX Index</div>
                <div class="rate-value small" id="vix-display">--</div>
            </div>
            <div class="rate-card">
                <div class="rate-title">Bitcoin (BTC)</div>
                <div class="rate-value small" id="btc-display">--</div>
            </div>
            <div class="rate-card">
                <div class="rate-title">Gold</div>
                <div class="rate-value small" id="gold-display">--</div>
            </div>
        </div>

        <div class="score-header">
            <div class="score-circle-premium" id="scoreValue">--</div>

            <div class="verdict-box">
                <span class="verdict-label">Regime Forecast</span>
                <div class="verdict-value-premium" id="verdictText">--</div>
                <div class="used-model-badge" id="usedModelDisplay">Waiting for input...</div>
            </div>
        </div>

        <div class="report-content">
            <h3>Executive Summary</h3>
            <p id="reportText" class="report-text-premium">
                Awaiting analysis initialization.
            </p>
        </div>

        <div class="model-breakdown-container">
            <span class="breakdown-title">Weekly Weighting Logic</span>
            <div class="model-breakdown-grid">
                <div class="breakdown-pill">
                    <span class="pill-weight">35%</span> Macro / Yields
                </div>
                <div class="breakdown-pill">
                    <span class="pill-weight">25%</span> Fed Policy
                </div>
                <div class="breakdown-pill">
                    <span class="pill-weight">15%</span> Tech Flow
                </div>
                <div class="breakdown-pill">
                    <span class="pill-weight">15%</span> Volatility
                </div>
                <div class="breakdown-pill">
                    <span class="pill-weight">10%</span> Geopolitics
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Priority List: Restored user requested models, with robust fallback
    const MODEL_PRIORITY = [
        "gemini-3-pro-preview",
        "gemini-3-flash-preview",
        "gemini-2.5-flash" // Fallback ensures stability
    ];

    const STORAGE_KEY = 'aura_gemini_key';

    document.addEventListener('DOMContentLoaded', () => {
        const savedKey = localStorage.getItem(STORAGE_KEY);
        if (savedKey) {
            document.getElementById('apiKey').value = savedKey;
        }
    });

    function clearKey() {
        if(confirm('Do you really want to remove the stored API key?')) {
            localStorage.removeItem(STORAGE_KEY);
            document.getElementById('apiKey').value = '';
            alert("API key removed.");
        }
    }

    async function startAnalysisChain() {
        const apiKeyInput = document.getElementById('apiKey');
        const apiKey = apiKeyInput.value.trim();
        const loadingDiv = document.getElementById('loading');
        const resultDiv = document.getElementById('result-section');
        const btn = document.querySelector('.btn-iridescent');
        const retryText = document.getElementById('retry-status');

        if (!apiKey) {
            alert('Please input your key here.');
            return;
        }

        localStorage.setItem(STORAGE_KEY, apiKey);

        btn.disabled = true;
        btn.innerHTML = "Analysing...";
        loadingDiv.style.display = 'block';
        resultDiv.style.display = 'none';
        retryText.textContent = "";

        await tryModel(0, apiKey);

        btn.disabled = false;
        btn.innerHTML = "Initialize Analysis";
        loadingDiv.style.display = 'none';
    }

    async function tryModel(index, apiKey) {
        const statusText = document.getElementById('loading-text');
        const retryText = document.getElementById('retry-status');

        if (index >= MODEL_PRIORITY.length) {
            alert("Analysis Failed: Unable to connect to Gemini or Search Grounding is unavailable. Please check your API key permissions.");
            return;
        }

        const currentModel = MODEL_PRIORITY[index];
        statusText.textContent = `Processing via ${currentModel}...`;

        try {
            const today = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            // Updated System Prompt for more data elements
            const systemPrompt = `
Date: ${today}.
Role: Quantitative Market Strategist.
Tools: Google Search (MANDATORY).

TASK:
1. Search for current market data: US 10Y Yield, US Inflation (CPI/PCE), CBOE VIX, Nasdaq Composite 5D %.
2. **CRITICAL:** Search for the specific CURRENT policy rates:
   - Federal Reserve Funds Rate (Upper Limit).
   - European Central Bank (ECB) Main Refinancing Operations Rate.
3. **NEW:** Search for live prices:
   - Bitcoin (BTC/USD)
   - Gold (XAU/USD)
   - US 10Y Yield (Current Value)
4. Perform the AURA Weekly Forecast scoring logic.

SCORING LOGIC (0-100 scale):
- Macro: Yields > 4.0% is bearish. Inflation > 2.5% is bearish.
- Fed: Hawkish words = Bearish (-). Dovish words = Bullish (+).
- Tech: Nasdaq 5D > 2% (Bullish), < -2% (Bearish).
- VIX: < 15 (Bullish), > 20 (Bearish).
- Geo: Risk of escalation = Bearish.

Total Score = (Macro*0.35) + (Fed*0.25) + (Tech*0.15) + (VIX*0.15) + (Geo*0.10)

VERDICT:
- Score >= 60: BULLISH
- Score <= 40: BEARISH
- Else: NEUTRAL

OUTPUT FORMAT:
Return ONLY a valid JSON object. Do not use Markdown code blocks.
Structure:
{
  "score": number (integer),
  "verdict": "BULLISH" | "BEARISH" | "NEUTRAL",
  "report": "100-140 words executive summary mentioning key inputs.",
  "fed_rate": "string (e.g. '5.50%')",
  "ecb_rate": "string (e.g. '3.25%')",
  "us10y_val": "string (e.g. '4.35%')",
  "vix_val": "string (e.g. '14.5')",
  "btc_val": "string (e.g. '$95,400')",
  "gold_val": "string (e.g. '$2,650')"
}
            `;

            const payload = {
                contents: [{ parts: [{ text: systemPrompt }] }],
                tools: [{ google_search: {} }]
            };

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${currentModel}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorBody}`);
            }

            const data = await response.json();

            if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                 throw new Error("Empty response from AI model.");
            }

            const textResponse = data.candidates[0].content.parts[0].text;
            const result = cleanAndParseJSON(textResponse);

            renderResults(result, currentModel);

        } catch (error) {
            console.warn(`Error with ${currentModel}: ${error.message}`);
            retryText.textContent = `Model ${currentModel} failed. Switching to backup...`;
            await new Promise(r => setTimeout(r, 1500)); // Short delay before retry
            await tryModel(index + 1, apiKey);
        }
    }

    // Robust JSON Extractor
    function cleanAndParseJSON(text) {
        try {
            // 1. Try direct parse
            return JSON.parse(text);
        } catch (e) {
            // 2. Try stripping markdown blocks
            let cleaned = text.replace(/```json/g, '').replace(/```/g, '').trim();
            try {
                return JSON.parse(cleaned);
            } catch (e2) {
                // 3. Regex extraction of the object
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                }
                throw new Error("Could not parse JSON response.");
            }
        }
    }

    function renderResults(data, modelName) {
        const resultSection = document.getElementById('result-section');
        const scoreVal = document.getElementById('scoreValue');
        const verdictTxt = document.getElementById('verdictText');
        const reportTxt = document.getElementById('reportText');
        const usedModelTxt = document.getElementById('usedModelDisplay');
        const fedRateTxt = document.getElementById('fed-rate-display');
        const ecbRateTxt = document.getElementById('ecb-rate-display');
        
        // New Elements
        const us10yTxt = document.getElementById('us10y-display');
        const vixTxt = document.getElementById('vix-display');
        const btcTxt = document.getElementById('btc-display');
        const goldTxt = document.getElementById('gold-display');

        // Populate Data
        scoreVal.textContent = data.score;
        verdictTxt.textContent = data.verdict;
        reportTxt.textContent = data.report;
        fedRateTxt.textContent = data.fed_rate || "N/A";
        ecbRateTxt.textContent = data.ecb_rate || "N/A";
        
        us10yTxt.textContent = data.us10y_val || "--";
        vixTxt.textContent = data.vix_val || "--";
        btcTxt.textContent = data.btc_val || "--";
        goldTxt.textContent = data.gold_val || "--";

        usedModelTxt.textContent = `Source: Google Search via ${modelName}`;

        // Styling based on Verdict
        verdictTxt.className = 'verdict-value-premium';
        // Reset score circle styling to default rainbow first
        scoreVal.style.color = '#fff';
        
        // Remove old classes
        verdictTxt.classList.remove('v-bullish', 'v-bearish', 'v-neutral');

        const vUpper = String(data.verdict).toUpperCase();
        if (vUpper.includes('BULL')) {
            verdictTxt.classList.add('v-bullish');
            scoreVal.style.color = 'var(--success)';
            // Override gradient for specific states if desired, or keep rainbow
        } else if (vUpper.includes('BEAR')) {
            verdictTxt.classList.add('v-bearish');
            scoreVal.style.color = 'var(--danger)';
        } else {
            verdictTxt.classList.add('v-neutral');
            scoreVal.style.color = 'var(--neutral)';
        }

        resultSection.style.display = 'block';
        resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
</script>

</body>
</html>
