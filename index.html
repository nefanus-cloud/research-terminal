<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AURA | Quantitative Market Sentinel</title>

    <!-- Dynamic Favicon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='0%25'%3E%3Cstop offset='0%25' style='stop-color:%2360a5fa'/%3E%3Cstop offset='50%25' style='stop-color:%23c084fc'/%3E%3Cstop offset='100%25' style='stop-color:%23f472b6'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='32' cy='32' r='30' fill='%23000000' stroke='url(%23g)' stroke-width='2'/%3E%3Cpath d='M32 14L50 50H14L32 14Z' fill='none' stroke='url(%23g)' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E" type="image/svg+xml">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=SF+Pro+Display:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Apple-esque Dark Mode Palette */
            --bg-deep: #000000;
            
            /* Glassmorphism Variables */
            --glass-surface: rgba(20, 20, 23, 0.65);
            --glass-border: rgba(255, 255, 255, 0.12);
            --glass-highlight: rgba(255, 255, 255, 0.05);
            --glass-blur: blur(40px);
            
            /* Text Colors */
            --text-primary: #f5f5f7;
            --text-secondary: #86868b;
            --text-tertiary: #6e6e73;
            --text-bright-subtitle: #d1d1d6; /* New brighter color for subtitle */

            /* Iridescent Gradients (The "Rainbow" Effect) */
            --gradient-iridescent: linear-gradient(135deg, #60a5fa 0%, #c084fc 50%, #f472b6 100%);
            
            /* Semantic Colors */
            --success: #32d74b;
            --danger: #ff453a;
            --neutral: #ff9f0a;

            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background-color: var(--bg-deep);
            color: var(--text-primary);
            font-family: var(--font-main);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden; /* Prevent horizontal scroll from effects */
            -webkit-font-smoothing: antialiased;
        }

        /* --- Ambient Background Orbs --- */
        .ambient-light {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            animation: floatOrb 20s infinite ease-in-out;
        }

        /* Responsive Orb Sizes */
        .orb-1 { width: min(600px, 60vw); height: min(600px, 60vw); background: #2563eb; top: -10%; left: -10%; animation-delay: 0s; }
        .orb-2 { width: min(500px, 50vw); height: min(500px, 50vw); background: #9333ea; bottom: -10%; right: -10%; animation-delay: -5s; }
        .orb-3 { width: min(400px, 40vw); height: min(400px, 40vw); background: #db2777; top: 40%; left: 40%; animation-delay: -10s; opacity: 0.2; }

        @keyframes floatOrb {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
        }

        /* --- Ticker --- */
        .tv-ticker-wrapper {
            width: 100%;
            height: 48px;
            position: sticky;
            top: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
        }

        .container {
            width: 100%;
            max-width: 860px;
            padding: 5rem 2rem 3rem 2rem;
            box-sizing: border-box;
            position: relative;
            z-index: 1;
        }

        /* --- Typography --- */
        header {
            text-align: center;
            margin-bottom: 4rem;
        }

        /* RAINBOW FROSTED TEXT STYLE */
        h1.brand-title {
            font-size: 6rem; /* Increased from 3.5rem for bigger impact */
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.02em;
            
            /* Rainbow Gradient Background */
            background: linear-gradient(
                135deg, 
                #60a5fa 0%, 
                #c084fc 25%, 
                #f472b6 50%, 
                #c084fc 75%, 
                #60a5fa 100%
            );
            background-size: 200% auto;
            
            /* Clip to text */
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            
            /* Frosted/Glowing Effect - UPDATED for sharper glow + outer bloom */
            filter: drop-shadow(0 0 8px rgba(192, 132, 252, 0.6)) drop-shadow(0 0 30px rgba(192, 132, 252, 0.4));
            
            /* Subtle Shine Animation */
            animation: textShine 4s linear infinite;
        }

        @keyframes textShine {
            to { background-position: 200% center; }
        }

        .subtitle {
            color: var(--text-bright-subtitle); /* UPDATED: Brighter color */
            font-size: 1.25rem; 
            margin-top: 0.5rem;
            font-weight: 400;
            letter-spacing: 0.02em;
            /* UPDATED: Subtle glow for readability */
            text-shadow: 0 0 15px rgba(255,255,255,0.1);
        }

        /* --- Apple-style Frosted Glass Card --- */
        .glass-card {
            background: var(--glass-surface);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 3rem;
            box-shadow: 
                0 40px 80px -20px rgba(0, 0, 0, 0.5),
                inset 0 0 0 1px var(--glass-highlight);
            margin-bottom: 2.5rem;
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), box-shadow 0.4s ease;
            position: relative;
            overflow: hidden;
            word-wrap: break-word; /* Prevents layout breaks */
        }
        
        /* Subtle shine effect on top of card */
        .glass-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        }

        /* --- Inputs --- */
        .input-group { margin-bottom: 1.5rem; }

        label.premium-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .clear-key-link {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            text-decoration: none;
            cursor: pointer;
            transition: color 0.2s;
        }
        .clear-key-link:hover { color: var(--danger); }

        input[type="password"] {
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            padding: 18px 20px;
            border-radius: 14px;
            font-family: var(--font-main);
            font-size: 16px; /* Prevents iOS zoom */
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: #60a5fa;
            background: rgba(0, 0, 0, 0.4);
            box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.15);
        }

        /* Security Note Style */
        .security-note {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-top: 0.8rem;
            padding-left: 4px;
        }

        /* Custom Placeholder Color - UPDATED: Increased contrast */
        ::placeholder {
            color: rgba(255, 255, 255, 0.5); /* Was 0.3 */
            font-weight: 300;
        }

        /* --- Horizon Selector --- */
        .horizon-selector-container {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 14px;
            padding: 4px;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .horizon-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
            font-family: var(--font-main);
        }

        .horizon-btn:hover {
            color: var(--text-primary);
        }

        .horizon-btn.active {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-weight: 600;
        }
        
        /* Optional glow for active state */
        .horizon-btn.active::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 10px;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1);
            pointer-events: none;
        }


        .info-text {
            font-size: 0.95rem;
            color: var(--text-secondary);
            line-height: 1.6;
            background: rgba(255, 255, 255, 0.03);
            padding: 1.5rem;
            border-radius: 16px;
            margin-bottom: 2rem;
        }

        /* --- Iridescent Button --- */
        .btn-iridescent {
            background: var(--gradient-iridescent);
            background-size: 200% 200%;
            animation: gradientMove 5s ease infinite;
            color: #ffffff;
            border: none;
            padding: 18px 32px;
            border-radius: 99px; /* Pill shape */
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            box-shadow: 0 10px 30px -10px rgba(192, 132, 252, 0.5);
            position: relative;
            overflow: hidden;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .btn-iridescent:hover {
            transform: scale(1.02);
            box-shadow: 0 15px 40px -10px rgba(192, 132, 252, 0.7);
        }

        .btn-iridescent:active { transform: scale(0.98); }

        .btn-iridescent:disabled {
            background: #2c2c2e;
            color: #636366;
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
            animation: none;
        }

        /* --- Loading State --- */
        .loading-container {
            text-align: center;
            display: none;
            padding: 4rem 0;
        }

        .iridescent-spinner {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient-iridescent);
            mask: radial-gradient(transparent 55%, black 56%);
            -webkit-mask: radial-gradient(transparent 55%, black 56%);
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem auto;
        }

        #loading-text { 
            background: var(--gradient-iridescent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 600; 
            font-size: 1.2rem; 
            margin-bottom: 0.5rem; 
        }
        #loading-subtext { color: var(--text-secondary); }
        #retry-status { color: var(--text-tertiary); font-style: italic; margin-top: 1rem; min-height: 1.2em; font-size: 0.9rem; }

        /* --- Results Section --- */
        #result-section {
            display: none;
            animation: slideUpFade 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* --- Dashboard Grids --- */
        .section-title {
             font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 1rem; display: block; font-weight: 600;
        }

        .rates-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .internals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin-bottom: 2.5rem;
        }

        .rate-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 18px;
            padding: 1.5rem;
            text-align: center;
            transition: background 0.2s;
        }
        .rate-card:hover { background: rgba(255,255,255,0.05); }

        .rate-title {
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .rate-value {
            font-size: 2rem;
            color: var(--text-primary);
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        
        .rate-value.small { font-size: 1.5rem; }

        /* --- Score & Verdict --- */
        .score-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2.5rem;
            padding-bottom: 2.5rem;
            border-bottom: 1px solid var(--glass-border);
            flex-wrap: wrap; /* Fix for mobile overlapping */
            gap: 2rem;
        }

        .score-circle-premium {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            /* Rainbow border logic */
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.5rem;
            font-weight: 700;
            color: #fff;
            background: #1c1c1e; /* Inner bg */
            z-index: 1;
            flex-shrink: 0; /* Prevent shrinking on mobile */
        }
        
        /* Gradient Border for Score Circle */
        .score-circle-premium::before {
            content: "";
            position: absolute;
            inset: -3px; /* Border width */
            border-radius: 50%;
            background: var(--gradient-iridescent);
            z-index: -1;
            opacity: 0.6;
        }

        .verdict-box { 
            text-align: right; 
            flex-grow: 1;
        }
        
        .verdict-label { display: block; color: var(--text-secondary); font-size: 0.85rem; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 0.5rem;}

        .verdict-value-premium {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .used-model-badge {
            display: inline-block;
            font-size: 0.75rem;
            color: var(--text-tertiary);
            background: rgba(255, 255, 255, 0.05);
            padding: 6px 14px;
            border-radius: 20px;
            margin-top: 1rem;
        }

        /* --- Color Modifiers --- */
        .v-bullish { color: var(--success); text-shadow: 0 0 40px rgba(50, 215, 75, 0.4); }
        .v-bearish { color: var(--danger); text-shadow: 0 0 40px rgba(255, 69, 58, 0.4); }
        .v-neutral { color: var(--neutral); }

        /* --- Report Text --- */
        .report-content h3 {
            background: linear-gradient(90deg, #fff, #a1a1aa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            margin-top: 0;
            letter-spacing: -0.01em;
        }

        .report-text-premium {
            line-height: 1.8;
            color: var(--text-primary);
            white-space: pre-line;
            font-size: 1.05rem;
            font-weight: 300;
        }

        /* --- Breakdown Grid --- */
        .model-breakdown-container {
            margin-top: 3rem;
            border-top: 1px solid var(--glass-border);
            padding-top: 2rem;
        }
        
        .model-breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
        }

        .breakdown-pill {
            background: rgba(255, 255, 255, 0.03);
            padding: 14px 18px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .breakdown-pill:hover { 
            background: rgba(255,255,255,0.06); 
            border-color: rgba(255,255,255,0.1);
            transform: translateY(-2px);
        }

        .pill-weight {
            font-weight: 700;
            /* Gradient text for percentage */
            background: var(--gradient-iridescent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-right: 10px;
            font-size: 1.1rem;
        }

        /* --- Animations --- */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideUpFade { from { opacity: 0; transform: translateY(40px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }

        /* --- Mobile --- */
        @media (max-width: 600px) {
            h1.brand-title { font-size: 3.5rem; } /* Adjusted mobile size up from 2.2rem */
            .score-header { flex-direction: column; text-align: center; gap: 2rem;}
            .verdict-box { text-align: center; }
            .glass-card { padding: 1.5rem; }
            .rates-grid { grid-template-columns: 1fr; }
            .orb { opacity: 0.3; }
        }
    </style>
</head>
<body>

    <!-- Ambient Background -->
    <div class="ambient-light">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

    <!-- TradingView Ticker Tape -->
    <div class="tv-ticker-wrapper">
        <div class="tradingview-widget-container">
            <div class="tradingview-widget-container__widget"></div>
            <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
            {
            "symbols": [
                { "proName": "NASDAQ:NVDA", "title": "NVIDIA" },
                { "proName": "NASDAQ:MSFT", "title": "Microsoft" },
                { "proName": "NASDAQ:AAPL", "title": "Apple" },
                { "proName": "NASDAQ:GOOGL", "title": "Alphabet" },
                { "proName": "NASDAQ:AMZN", "title": "Amazon" },
                { "proName": "NASDAQ:META", "title": "Meta" },
                { "proName": "FOREXCOM:SPXUSD", "title": "S&P 500" },
                { "proName": "FOREXCOM:NSXUSD", "title": "US 100" },
                { "proName": "FX:EURUSD", "title": "EUR/USD" }
            ],
            "showSymbolLogo": true,
            "colorTheme": "dark",
            "isTransparent": true,
            "displayMode": "adaptive",
            "locale": "en"
            }
            </script>
        </div>
    </div>

<div class="container">
    <header>
        <h1 class="brand-title">AURA</h1>
        <div class="subtitle">Quantitative Market Intelligence</div>
    </header>

    <div class="glass-card">
        <div class="input-group">
            <label for="apiKey" class="premium-label">
                Gemini API Key
                <span class="clear-key-link" onclick="clearKey()" title="Remove key from local storage">Clear saved key</span>
            </label>
            <!-- Clean placeholder, info moved below -->
            <input type="password" id="apiKey" placeholder="Enter Gemini API Key">
            
            <!-- New adequate location for storage info -->
            <div class="security-note">
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.7;"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                Your key is stored securely in your browser's local storage.
            </div>
        </div>

        <!-- NEW HORIZON SELECTOR -->
        <label class="premium-label">Analysis Horizon</label>
        <div class="horizon-selector-container">
            <button class="horizon-btn" onclick="selectHorizon(this, 'Day')">Day</button>
            <button class="horizon-btn active" onclick="selectHorizon(this, 'Week')">Week</button>
            <button class="horizon-btn" onclick="selectHorizon(this, 'Month')">Month</button>
            <button class="horizon-btn" onclick="selectHorizon(this, 'Year')">Year</button>
        </div>

        <div class="info-text">
            <span style="color: #fff; font-weight: 500;">Research Protocol:</span>
            System executes deep search for Momentum (Tech/BTC), Liquidity Stress (Yields), and Volatility. Scoring weights adapt automatically to the selected time horizon.
        </div>

        <button class="btn-iridescent" onclick="startAnalysisChain()">Initialize Analysis</button>
    </div>

    <!-- Loading Screen -->
    <div id="loading" class="loading-container">
        <div class="iridescent-spinner"></div>
        <div id="loading-text">Synthesizing Data...</div>
        <div id="loading-subtext">Calculating Vectors for Selected Horizon</div>
        <div id="retry-status"></div>
    </div>

    <!-- Results Dashboard -->
    <div id="result-section" class="glass-card">
        
        <!-- Live Rates Display -->
        <h4 class="section-title">Central Bank Policy</h4>
        <div class="rates-grid">
            <div class="rate-card">
                <div class="rate-title">Fed Funds (Upper)</div>
                <div class="rate-value" id="fed-rate-display">--%</div>
            </div>
            <div class="rate-card">
                <div class="rate-title">ECB (Main Refi)</div>
                <div class="rate-value" id="ecb-rate-display">--%</div>
            </div>
        </div>

        <!-- NEW: Market Internals -->
        <h4 class="section-title">Market Internals</h4>
        <div class="internals-grid">
            <div class="rate-card">
                <div class="rate-title">US 10Y Yield</div>
                <div class="rate-value small" id="us10y-display">--%</div>
            </div>
            <div class="rate-card">
                <div class="rate-title">VIX Index</div>
                <div class="rate-value small" id="vix-display">--</div>
            </div>
            <div class="rate-card">
                <div class="rate-title">Bitcoin (BTC)</div>
                <div class="rate-value small" id="btc-display">--</div>
            </div>
            <div class="rate-card">
                <div class="rate-title">Gold</div>
                <div class="rate-value small" id="gold-display">--</div>
            </div>
        </div>

        <div class="score-header">
            <div class="score-circle-premium" id="scoreValue">--</div>

            <div class="verdict-box">
                <span class="verdict-label" id="forecast-label">Regime Forecast (Week)</span>
                <div class="verdict-value-premium" id="verdictText">--</div>
                <div class="used-model-badge" id="usedModelDisplay">Waiting for input...</div>
            </div>
        </div>

        <div class="report-content">
            <h3>Executive Summary</h3>
            <p id="reportText" class="report-text-premium">
                Awaiting analysis initialization.
            </p>
        </div>

        <div class="model-breakdown-container">
            <span class="breakdown-title" id="weighting-title">High-Predictability Weighting (Week Horizon)</span>
            <div class="model-breakdown-grid" id="breakdown-grid">
                <!-- Weights injected via JS -->
                <div class="breakdown-pill"><span class="pill-weight">--%</span> Loading...</div>
            </div>
        </div>
    </div>
</div>

<script>
    const MODEL_PRIORITY = [
        "gemini-3-pro-preview",
        "gemini-3-flash-preview",
        "gemini-2.5-flash" 
    ];

    const STORAGE_KEY = 'aura_gemini_key';
    let currentHorizon = 'Week'; // Default

    document.addEventListener('DOMContentLoaded', () => {
        const savedKey = localStorage.getItem(STORAGE_KEY);
        if (savedKey) {
            document.getElementById('apiKey').value = savedKey;
        }
        updateWeightsUI('Week');
    });

    function selectHorizon(btn, horizon) {
        // Update UI
        document.querySelectorAll('.horizon-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentHorizon = horizon;
        updateWeightsUI(horizon);
    }

    function updateWeightsUI(horizon) {
        const label = document.getElementById('forecast-label');
        const title = document.getElementById('weighting-title');
        const grid = document.getElementById('breakdown-grid');

        label.textContent = `Regime Forecast (${horizon})`;
        title.textContent = `Optimized Weighting (${horizon} Horizon)`;

        let pills = '';
        if (horizon === 'Day') {
             pills = `
                <div class="breakdown-pill"><span class="pill-weight">40%</span> Intraday Mom.</div>
                <div class="breakdown-pill"><span class="pill-weight">30%</span> VIX/Vol</div>
                <div class="breakdown-pill"><span class="pill-weight">20%</span> News/Flow</div>
                <div class="breakdown-pill"><span class="pill-weight">10%</span> Macro</div>
             `;
        } else if (horizon === 'Week') {
             pills = `
                <div class="breakdown-pill"><span class="pill-weight">30%</span> Momentum</div>
                <div class="breakdown-pill"><span class="pill-weight">25%</span> Volatility</div>
                <div class="breakdown-pill"><span class="pill-weight">25%</span> Yields</div>
                <div class="breakdown-pill"><span class="pill-weight">20%</span> Macro</div>
             `;
        } else if (horizon === 'Month') {
             pills = `
                <div class="breakdown-pill"><span class="pill-weight">40%</span> Macro Data</div>
                <div class="breakdown-pill"><span class="pill-weight">30%</span> Earnings</div>
                <div class="breakdown-pill"><span class="pill-weight">20%</span> Fed Policy</div>
                <div class="breakdown-pill"><span class="pill-weight">10%</span> Seasonality</div>
             `;
        } else if (horizon === 'Year') {
             pills = `
                <div class="breakdown-pill"><span class="pill-weight">40%</span> Fed/Rates</div>
                <div class="breakdown-pill"><span class="pill-weight">30%</span> Valuation</div>
                <div class="breakdown-pill"><span class="pill-weight">20%</span> Geopolitics</div>
                <div class="breakdown-pill"><span class="pill-weight">10%</span> Demographics</div>
             `;
        }
        grid.innerHTML = pills;
    }

    function clearKey() {
        if(confirm('Do you really want to remove the stored API key?')) {
            localStorage.removeItem(STORAGE_KEY);
            document.getElementById('apiKey').value = '';
            alert("API key removed.");
        }
    }

    async function startAnalysisChain() {
        const apiKeyInput = document.getElementById('apiKey');
        const apiKey = apiKeyInput.value.trim();
        const loadingDiv = document.getElementById('loading');
        const resultDiv = document.getElementById('result-section');
        const btn = document.querySelector('.btn-iridescent');
        const retryText = document.getElementById('retry-status');

        if (!apiKey) {
            alert('Please enter your Gemini API Key.');
            return;
        }

        localStorage.setItem(STORAGE_KEY, apiKey);

        btn.disabled = true;
        btn.innerHTML = `Analyzing (${currentHorizon})...`;
        loadingDiv.style.display = 'block';
        resultDiv.style.display = 'none';
        retryText.textContent = "";

        await tryModel(0, apiKey);

        btn.disabled = false;
        btn.innerHTML = "Initialize Analysis";
        loadingDiv.style.display = 'none';
    }

    async function tryModel(index, apiKey) {
        const statusText = document.getElementById('loading-text');
        const retryText = document.getElementById('retry-status');

        if (index >= MODEL_PRIORITY.length) {
            alert("Analysis Failed: Unable to connect to Gemini or Search Grounding is unavailable.");
            return;
        }

        const currentModel = MODEL_PRIORITY[index];
        statusText.textContent = `Processing via ${currentModel}...`;

        try {
            const today = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            /* ==========================================================
               UPDATED: MARKET-CREDITED, HORIZON-SPECIFIC, DETERMINISTIC
               ========================================================== */
            const systemPrompt = `
Date: ${today}.
Role: Quantitative Market Strategist.
Tools: Google Search (MANDATORY). You MUST use search for every required metric.

MISSION:
Produce a market-credited REGIME SCORE (0–100) for the ${currentHorizon.toUpperCase()} horizon.
"Credit the market" means the score is anchored primarily to price action and volatility over the selected horizon.
Macro/news can refine but must not override market behavior without a clear risk event.

NON-NEGOTIABLE RULES:
1) Do NOT invent numbers. If a metric cannot be found reliably, output "N/A" for that value and set that factor to N/A (then re-normalize weights across remaining factors).
2) You MUST compute the final score using the deterministic subscore rules and weights below (no intuition scoring).
3) Output JSON ONLY. No markdown. No commentary.

REQUIRED DATA (via Google Search):
A) Returns over the chosen horizon (must match horizon):
   - Nasdaq Composite (preferred). If unavailable, Nasdaq-100 is acceptable but note it internally.
   - Bitcoin (BTC/USD)
   - Gold (XAU/USD)
   For each: obtain CURRENT level and RETURN over horizon:
   - DAY: 1D %
   - WEEK: 5D %
   - MONTH: 1M %
   - YEAR: 12M %

B) Volatility:
   - VIX current level
   - If possible: VIX change over the horizon (otherwise N/A)

C) Rates / liquidity:
   - US 10Y Treasury yield current level
   - US 10Y change over horizon in basis points (if available, else N/A)
   - Fed Funds target range (upper bound)
   - ECB main refinancing rate

D) Macro trend (ONLY if horizon is Week/Month/Year):
   - Inflation trend direction using latest CPI YoY or PCE YoY vs prior release (UP/DOWN/FLAT).
   - If a credible recession escalation proxy exists (yield curve inversion worsening, recession probability rising), use it; otherwise mark macro as "unclear".

E) Headlines (ONLY if horizon is Day/Week):
   - Identify any market-moving risk headline in last 24–72h (1–2 bullets internally) and convert to a headlines subscore.

DETERMINISTIC SUBSCORES (0–100):

1) PRICE MOMENTUM SUBSCORE:
Compute risk_return = average(Nasdaq_return%, BTC_return%) for the horizon.
Use horizon thresholds:
- Day threshold = 2%
- Week threshold = 4%
- Month threshold = 6%
- Year threshold = 12%

Mapping:
- risk_return >= +threshold  -> 85
- +1% to (threshold - epsilon) -> 70
- -1% to +1% -> 55
- (-threshold + epsilon) to -1% -> 35
- risk_return <= -threshold -> 15

2) VOLATILITY SUBSCORE (VIX level):
- VIX <= 14 -> 85
- 14 < VIX <= 18 -> 70
- 18 < VIX <= 24 -> 50
- 24 < VIX <= 35 -> 30
- VIX > 35 -> 15
If VIX change over horizon is available:
- If VIX rose materially (> +10% over horizon): subtract 10 (floor at 0)
- If VIX fell materially (< -10% over horizon): add 5 (cap at 100)

3) YIELD / LIQUIDITY STRESS SUBSCORE (US10Y):
Base by level:
- US10Y < 3.8% -> 80
- 3.8%–4.3% -> 60
- 4.3%–4.8% -> 40
- > 4.8% -> 25
Adjustment by change (if available):
- If yields rose > +20bp over horizon: -10
- If yields fell < -20bp over horizon: +10

4) MACRO TREND SUBSCORE (Week/Month/Year only):
- If inflation trend is DOWN vs prior reading and no clear growth shock: 70
- If inflation is UP or sticky: 45
- If credible recession escalation signal is present: 30
- If macro unclear/unavailable: 55
For Day: macro is N/A unless a truly dominant event occurred.

5) GOLD CONFIRMATION SUBSCORE:
Use gold return vs risk_return to confirm regime:
- risk_return > 0 and gold_return <= 0 -> 70 (risk-on consistent)
- risk_return < 0 and gold_return > 0 -> 70 (risk-off consistent)
- both up strongly -> 50 (inflation/liquidity mix)
- both down -> 35 (liquidity squeeze)
If gold return unavailable: 55

6) HEADLINES SUBSCORE (Day/Week only):
- Clear supportive risk-on headline environment -> 70
- Clear risk-off shock headline -> 30
- Otherwise -> 55
If no reliable headline info -> 55

HORIZON WEIGHTS (must be used exactly; re-normalize if any factor is N/A):
DAY:
- Price Momentum 45%
- Volatility 35%
- Yield/Liquidity 15%
- Headlines 5%
WEEK:
- Price Momentum 35%
- Volatility 25%
- Yield/Liquidity 20%
- Macro Trend 15%
- Gold Confirmation 5%
MONTH:
- Price Momentum 25%
- Yield/Liquidity 25%
- Macro Trend 25%
- Volatility 15%
- Gold Confirmation 10%
YEAR:
- Macro Trend 35%
- Yield/Liquidity 25%
- Price Momentum 20%
- Volatility 10%
- Gold Confirmation 10%

FINAL SCORE:
Compute weighted average of available subscores, re-normalizing weights if any are N/A.
Round to nearest integer.

VERDICT:
- Score >= 60: BULLISH
- Score <= 40: BEARISH
- Else: NEUTRAL

REPORT (120–150 words, tailored to ${currentHorizon}):
- First sentence must be: "Market-credited read for ${currentHorizon}: ..."
- Mention whether price + vol + yields agree or diverge.
- Name the top 2–3 drivers based on computed subscores (not opinions).
- Provide 1 horizon-appropriate risk to watch.

OUTPUT JSON ONLY:
{
  "score": number (integer 0-100),
  "verdict": "BULLISH" | "BEARISH" | "NEUTRAL",
  "report": "120-150 words executive summary tailored to the ${currentHorizon} horizon.",
  "fed_rate": "string",
  "ecb_rate": "string",
  "us10y_val": "string",
  "vix_val": "string",
  "btc_val": "string",
  "gold_val": "string"
}
            `;

            const payload = {
                contents: [{ parts: [{ text: systemPrompt }] }],
                tools: [{ google_search: {} }]
            };

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${currentModel}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorBody}`);
            }

            const data = await response.json();

            if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                 throw new Error("Empty response from AI model.");
            }

            const textResponse = data.candidates[0].content.parts[0].text;
            const result = cleanAndParseJSON(textResponse);

            renderResults(result, currentModel);

        } catch (error) {
            console.warn(`Error with ${currentModel}: ${error.message}`);
            retryText.textContent = `Model ${currentModel} failed. Switching to backup...`;
            await new Promise(r => setTimeout(r, 1500));
            await tryModel(index + 1, apiKey);
        }
    }

    function cleanAndParseJSON(text) {
        try {
            return JSON.parse(text);
        } catch (e) {
            let cleaned = text.replace(/```json/g, '').replace(/```/g, '').trim();
            try { return JSON.parse(cleaned); } 
            catch (e2) {
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (jsonMatch) return JSON.parse(jsonMatch[0]);
                throw new Error("Could not parse JSON response.");
            }
        }
    }

    function renderResults(data, modelName) {
        const resultSection = document.getElementById('result-section');
        const scoreVal = document.getElementById('scoreValue');
        const verdictTxt = document.getElementById('verdictText');
        const reportTxt = document.getElementById('reportText');
        const usedModelTxt = document.getElementById('usedModelDisplay');
        const fedRateTxt = document.getElementById('fed-rate-display');
        const ecbRateTxt = document.getElementById('ecb-rate-display');
        const us10yTxt = document.getElementById('us10y-display');
        const vixTxt = document.getElementById('vix-display');
        const btcTxt = document.getElementById('btc-display');
        const goldTxt = document.getElementById('gold-display');

        // Populate Data
        scoreVal.textContent = data.score;
        verdictTxt.textContent = data.verdict;
        reportTxt.textContent = data.report;
        fedRateTxt.textContent = data.fed_rate || "N/A";
        ecbRateTxt.textContent = data.ecb_rate || "N/A";
        us10yTxt.textContent = data.us10y_val || "--";
        vixTxt.textContent = data.vix_val || "--";
        btcTxt.textContent = data.btc_val || "--";
        goldTxt.textContent = data.gold_val || "--";

        usedModelTxt.textContent = `Source: Google Search via ${modelName}`;

        // Styling based on Verdict
        verdictTxt.className = 'verdict-value-premium';
        scoreVal.style.color = '#fff';
        verdictTxt.classList.remove('v-bullish', 'v-bearish', 'v-neutral');

        const vUpper = String(data.verdict).toUpperCase();
        if (vUpper.includes('BULL')) {
            verdictTxt.classList.add('v-bullish');
            scoreVal.style.color = 'var(--success)';
        } else if (vUpper.includes('BEAR')) {
            verdictTxt.classList.add('v-bearish');
            scoreVal.style.color = 'var(--danger)';
        } else {
            verdictTxt.classList.add('v-neutral');
            scoreVal.style.color = 'var(--neutral)';
        }

        resultSection.style.display = 'block';
        resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
</script>

</body>
</html>
